<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم HMAS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-dark: #1a1d24; --bg-medium: #242832; --bg-light: #2e3340; --bg-very-light: #3a4150;
            --text-primary: #e1e3e8; --text-secondary: #8c96a9;
            --primary-color: #e84545; --primary-hover: #d13d3d;
            --accent-color: #5d5dff; --accent-hover: #4b4acf;
            --border-color: #3a4150; --shadow-color: rgba(0, 0, 0, 0.2);
            --font-family: 'Tajawal', sans-serif; --border-radius: 8px;
        }
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: var(--font-family); 
            background-color: var(--bg-dark); 
            color: var(--text-primary); 
            line-height: 1.6; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
        }
        
        /* شاشة تسجيل الدخول للمدير */
        #admin-login-screen { 
            width: 100%; 
            max-width: 400px; 
            padding: 20px; 
        }
        .login-container { 
            background-color: var(--bg-medium); 
            padding: 40px; 
            border-radius: var(--border-radius); 
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px var(--shadow-color);
        }
        .login-container h2 { 
            text-align: center; 
            margin-bottom: 25px; 
            color: var(--primary-color); 
            font-weight: 700;
        }
        
        /* لوحة التحكم الرئيسية */
        .admin-container { 
            display: flex; 
            min-height: 100vh; 
            width: 100%; 
            height: 100%;
        }
        .sidebar { 
            width: 250px; 
            background-color: var(--bg-medium); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid var(--border-color); 
        }
        .logo { 
            font-size: 2rem; 
            text-align: center; 
            margin-bottom: 40px; 
            color: var(--primary-color); 
            font-weight: 700; 
        }
        .sidebar nav { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .nav-link { 
            color: var(--text-secondary); 
            text-decoration: none; 
            padding: 12px 15px; 
            border-radius: var(--border-radius); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            transition: background-color 0.2s, color 0.2s; 
        }
        .nav-link i { 
            width: 20px; 
            text-align: center; 
        }
        .nav-link:hover { 
            background-color: var(--bg-light); 
            color: var(--text-primary); 
        }
        .nav-link.active { 
            background-color: var(--primary-color); 
            color: white; 
            font-weight: 700; 
        }
        .main-content { 
            flex: 1; 
            padding: 30px; 
            overflow-x: hidden; 
            overflow-y: auto;
        }
        .page { 
            display: none; 
            animation: fadeIn 0.4s ease; 
        }
        .page.active { 
            display: block; 
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { 
            margin-bottom: 30px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .page-header h2 { 
            font-size: 1.8rem; 
        }
        .content-wrapper { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 30px; 
        }
        .form-container, .list-container { 
            background-color: var(--bg-medium); 
            padding: 25px; 
            border-radius: var(--border-radius); 
            border: 1px solid var(--border-color); 
        }
        .form-container h3, .list-container h3 { 
            margin-top: 0; 
            margin-bottom: 20px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 10px; 
        }
        .input-group { 
            margin-bottom: 15px; 
        }
        .input-group label { 
            display: block; 
            margin-bottom: 5px; 
            color: var(--text-secondary); 
            font-size: 0.9rem; 
        }
        .input-group input, .input-group textarea { 
            width: 100%; 
            padding: 10px; 
            background-color: var(--bg-dark); 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius); 
            color: var(--text-primary); 
            font-family: var(--font-family); 
        }
        .input-group textarea { 
            resize: vertical; 
            min-height: 80px; 
        }
        .btn { 
            padding: 10px 15px; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            font-family: var(--font-family); 
            font-weight: 700; 
            transition: background-color 0.2s; 
        }
        .btn-primary { 
            background-color: var(--primary-color); 
            color: white; 
        }
        .btn-primary:hover { 
            background-color: var(--primary-hover); 
        }
        .btn-secondary { 
            background-color: var(--bg-light); 
            color: var(--text-primary); 
        }
        .btn-secondary:hover { 
            background-color: var(--bg-very-light); 
        }
        .item-list { 
            display: grid; 
            gap: 15px; 
        }
        .list-card { 
            background-color: var(--bg-light); 
            padding: 15px; 
            border-radius: var(--border-radius); 
            border: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            transition: background-color 0.2s, transform 0.2s; 
        }
        .list-card:hover { 
            background-color: var(--bg-very-light); 
            transform: translateY(-2px); 
        }
        .card-content { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            overflow: hidden; 
        }
        .card-content i { 
            font-size: 1.5rem; 
            color: var(--accent-color); 
        }
        .card-title { 
            font-weight: 700; 
        }
        .card-actions { 
            display: flex; 
            gap: 10px; 
        }
        .action-btn { 
            background: none; 
            border: none; 
            color: var(--text-secondary); 
            cursor: pointer; 
            font-size: 1rem; 
            transition: color 0.2s; 
        }
        .action-btn.edit:hover { 
            color: var(--accent-color); 
        }
        .action-btn.delete:hover { 
            color: var(--primary-color); 
        }
        .user-table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        .user-table th, .user-table td { 
            padding: 12px; 
            text-align: right; 
            border-bottom: 1px solid var(--border-color); 
        }
        .user-table th { 
            background-color: var(--bg-light); 
        }
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.7); 
            backdrop-filter: blur(5px); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            animation: fadeIn 0.3s; 
        }
        .modal-window { 
            background-color: var(--bg-medium); 
            padding: 30px; 
            border-radius: var(--border-radius); 
            width: 90%; 
            max-width: 500px; 
        }
        .icon-selector { 
            width: 90%; 
            max-width: 500px; 
        }
        .icon-selector h3 { 
            margin-top: 0; 
        }
        .icon-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
            gap: 10px; 
            max-height: 300px; 
            overflow-y: auto; 
            margin-top: 15px; 
            padding: 5px; 
        }
        .icon-option { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 5px; 
            padding: 10px; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        .icon-option:hover, .icon-option.selected { 
            background-color: var(--accent-color); 
            color: white; 
        }
        .icon-option i { 
            font-size: 1.8rem; 
        }
        .icon-option span { 
            font-size: 0.8rem; 
        }
        .file-card { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background-color: var(--bg-dark); 
            padding: 10px 15px; 
            border-radius: var(--border-radius); 
        }
        .file-info { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .file-info i { 
            color: var(--text-secondary); 
        }
        .new-badge { 
            background-color: var(--accent-color); 
            color: white; 
            font-size: 0.7rem; 
            padding: 2px 6px; 
            border-radius: 4px; 
            margin-right: 8px; 
        }
        .hidden { 
            display: none !important; 
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول للمدير -->
    <div id="admin-login-screen">
        <div class="login-container">
            <h2>لوحة تحكم HMAS</h2>
            <form id="admin-login-form">
                <div class="input-group">
                    <label for="admin-id">رقم المدير</label>
                    <input type="text" id="admin-id" required value="781293367">
                </div>
                <div class="input-group">
                    <label for="admin-password">كلمة المرور</label>
                    <input type="password" id="admin-password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">دخول</button>
                <p id="login-error-msg" style="color: var(--primary-color); text-align:center; margin-top: 15px; display: none;"></p>
            </form>
        </div>
    </div>

    <!-- لوحة التحكم الرئيسية (مخفية افتراضيًا) -->
    <div id="admin-dashboard" class="admin-container hidden">
        <aside class="sidebar">
            <h1 class="logo">HMAS</h1>
            <nav>
                <a href="#page-sections" class="nav-link active"><i class="fas fa-sitemap"></i> إدارة الأقسام</a>
                <a href="#page-news" class="nav-link"><i class="fas fa-bullhorn"></i> الأخبار</a>
                <a href="#page-ads" class="nav-link"><i class="fas fa-ad"></i> الإعلانات</a>
                <a href="#page-users" class="nav-link"><i class="fas fa-users-cog"></i> إدارة الطلاب</a>
            </nav>
            <button id="admin-logout-btn" class="btn btn-secondary" style="margin-top: auto;">تسجيل الخروج</button>
        </aside>

        <main class="main-content">
            <!-- صفحة إدارة الأقسام الرئيسية -->
            <div id="page-sections" class="page active">
                <div class="page-header"><h2>إدارة الأقسام</h2></div>
                <div class="content-wrapper" style="grid-template-columns: 3fr 1fr; align-items: flex-start;">
                    <div class="list-container"><h3>الأقسام الحالية</h3><div id="sections-list" class="item-list"></div></div>
                    <div class="form-container"><h3 id="section-form-title">إضافة قسم جديد</h3><form id="section-form"><input type="hidden" id="section-id"><div class="input-group"><label for="section-title">عنوان القسم</label><input type="text" id="section-title" required></div><div class="input-group"><label for="section-description">وصف القسم</label><textarea id="section-description"></textarea></div><div class="input-group"><label>أيقونة القسم</label><input type="hidden" id="section-icon" required><button type="button" id="open-icon-selector" class="btn btn-secondary">اختر أيقونة</button><div id="selected-icon-preview" style="margin-top: 10px; text-align: center;"></div></div><button type="submit" class="btn btn-primary" style="width: auto;">حفظ القسم</button><button type="button" id="cancel-edit-section-btn" class="btn btn-secondary" style="display: none; width: auto;">إلغاء التعديل</button></form></div>
                </div>
            </div>
            <!-- صفحة تفاصيل القسم وإدارة ملفاته -->
            <div id="page-section-details" class="page">
                <div class="page-header"><button id="back-to-sections-btn" class="btn btn-secondary"><i class="fas fa-arrow-right"></i> العودة للأقسام</button><h2 id="details-section-title"></h2></div>
                <div class="content-wrapper" style="grid-template-columns: 3fr 1fr; align-items: flex-start;">
                    <div class="list-container"><h3>الملفات في هذا القسم</h3><div id="files-list" class="item-list"></div></div>
                    <div class="form-container"><h3>إضافة ملف جديد</h3><form id="file-form" enctype="multipart/form-data"><div class="input-group"><label for="file-display-name">اسم عرض الملف</label><input type="text" id="file-display-name" required></div><div class="input-group"><label for="file-input">اختر الملف (PDF, DOCX, ...)</label><input type="file" id="file-input" required></div><div class="input-group"><label for="file-new-duration">مدة علامة "جديد" (أيام)</label><input type="number" id="file-new-duration" placeholder="مثال: 7 (اتركه فارغًا بدون علامة)"></div><button type="submit" class="btn btn-primary" style="width: auto;">رفع الملف</button></form></div>
                </div>
            </div>
            <!-- صفحة الأخبار -->
            <div id="page-news" class="page"><div class="page-header"><h2>الأخبار والإعلانات المتحركة</h2></div><div class="form-container"><form id="news-form"><div class="input-group"><label for="news-content">محتوى شريط الأخبار</label><textarea id="news-content"></textarea></div><button type="submit" class="btn btn-primary" style="width: auto;">حفظ الخبر</button></form></div></div>
            <!-- صفحة الإعلانات -->
            <div id="page-ads" class="page"><div class="page-header"><h2>إدارة الإعلانات</h2></div><div class="form-container"><form id="ads-form"><div class="input-group"><label for="ad-code">كود الإعلان (HTML)</label><textarea id="ad-code"></textarea></div><button type="submit" class="btn btn-primary" style="width: auto;">حفظ الإعلان</button></form></div></div>
            <!-- صفحة إدارة الطلاب -->
            <div id="page-users" class="page"><div class="page-header"><h2>إدارة الطلاب</h2></div><div class="list-container"><table class="user-table"><thead><tr><th>الاسم</th><th>رقم الطالب</th><th>كلمة المرور (مشفرة)</th><th>إجراءات</th></tr></thead><tbody id="users-table-body"></tbody></table></div></div>
        </main>
    </div>
    <!-- نافذة اختيار الأيقونات -->
    <div id="icon-selector-modal" class="modal-overlay"><div class="modal-window icon-selector"><h3>اختر أيقونة للقسم</h3><div id="icon-grid" class="icon-grid"></div></div></div>
    <!-- نافذة تعديل الطالب -->
    <div id="edit-user-modal" class="modal-overlay"><div class="modal-window" id="edit-user-modal-content"><h3>تعديل بيانات الطالب</h3><form id="edit-user-form"><input type="hidden" id="edit-user-id"><div class="input-group"><label for="edit-user-name">الاسم</label><input type="text" id="edit-user-name" required></div><div class="input-group"><label for="edit-user-student-id">رقم الطالب</label><input type="text" id="edit-user-student-id" required></div><div class="input-group"><label for="edit-user-password">كلمة المرور الجديدة (اتركها فارغة لعدم التغيير)</label><input type="text" id="edit-user-password"></div><button type="submit" class="btn btn-primary" style="width: auto;">حفظ التعديلات</button><button type="button" id="cancel-edit-user-btn" class="btn btn-secondary" style="width: auto;">إلغاء</button></form></div></div>

    <!-- القسم الثاني (JavaScript) سيبدأ من هنا -->
    <script>
        // ===================================================================
        // HMAS - جافاسكريبت لوحة التحكم الكاملة
        // الإصدار: النهائي - 2025
        // ===================================================================
        document.addEventListener('DOMContentLoaded', () => {
            const App = {
                // (مهم) تأكد من تغيير هذا الرابط عند الرفع إلى Render
                apiBaseUrl: 'http://localhost:3000/api', 
                currentSectionId: null,
                token: null,
                icons: [
                    { class: 'fab fa-php', name: 'PHP' }, { class: 'fab fa-js-square', name: 'JavaScript' }, { class: 'fab fa-python', name: 'Python' }, { class: 'fab fa-java', name: 'Java' }, { class: 'fab fa-cuttlefish', name: 'C++' },
                    { class: 'fas fa-database', name: 'Database' }, { class: 'fab fa-css3-alt', name: 'CSS' }, { class: 'fab fa-html5', name: 'HTML' }, { class: 'fab fa-swift', name: 'Swift' }, { class: 'fas fa-gem', name: 'Ruby' },
                    { class: 'fas fa-brain', name: 'AI' }, { class: 'fas fa-laptop-code', name: 'حاسوب' }, { class: 'fas fa-project-diagram', name: 'خوارزميات' }, { class: 'fas fa-shield-alt', name: 'أمن' }, { class: 'fas fa-network-wired', name: 'شبكات' },
                    { class: 'fas fa-palette', name: 'رسم' }, { class: 'fas fa-atom', name: 'فيزياء' }, { class: 'fas fa-infinity', name: 'تفاضل' }, { class: 'fas fa-calculator', name: 'رياضيات' }, { class: 'fas fa-vr-cardboard', name: 'VR/AR' },
                    { class: 'fas fa-flag', name: 'صراع' }, { class: 'fas fa-check-double', name: 'انجليزية' }, { class: 'fas fa-language', name: 'عربية' }, { class: 'fas fa-mosque', name: 'إسلامية' }, { class: 'fas fa-folder', name: 'Default' }
                ]
            };

            // --- 1. دوال الواجهة الأساسية (UI Functions) ---
            const showLoginScreen = () => {
                document.getElementById('admin-login-screen').classList.remove('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
            };
            const showDashboard = () => {
                document.getElementById('admin-login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                navigate();
            };

            // --- 2. دالة التواصل مع الخادم (API Fetcher) ---
            const fetchAPI = async (endpoint, method = 'GET', body = null, isFormData = false) => {
                try {
                    const options = { 
                        method,
                        headers: {}
                    };
                    // إضافة توكن الحماية لجميع الطلبات
                    if (App.token) {
                        options.headers['Authorization'] = `Bearer ${App.token}`;
                    }
                    if (body) {
                        if (isFormData) {
                            options.body = body;
                        } else {
                            options.headers['Content-Type'] = 'application/json';
                            options.body = JSON.stringify(body);
                        }
                    }
                    const response = await fetch(`${App.apiBaseUrl}${endpoint}`, options);
                    const data = await response.json();
                    if (!response.ok) {
                        // إذا فشل التوكن، قم بتسجيل الخروج
                        if (response.status === 401 || response.status === 403) {
                            handleLogout();
                        }
                        throw new Error(data.message || 'حدث خطأ ما.');
                    }
                    return data;
                } catch (error) {
                    alert(`فشل: ${error.message}`);
                    throw error;
                }
            };

            // --- 3. إدارة تسجيل الدخول والخروج ---
            const handleLogin = async (e) => {
                e.preventDefault();
                const student_id = document.getElementById('admin-id').value;
                const password = document.getElementById('admin-password').value;
                const errorMsg = document.getElementById('login-error-msg');
                errorMsg.style.display = 'none';
                try {
                    const data = await fetchAPI('/admin/login', 'POST', { student_id, password });
                    if (data.success && data.token) {
                        App.token = data.token;
                        localStorage.setItem('hmas_admin_token', data.token); // حفظ التوكن
                        showDashboard();
                    }
                } catch (error) {
                    errorMsg.textContent = error.message;
                    errorMsg.style.display = 'block';
                }
            };

            const handleLogout = () => {
                App.token = null;
                localStorage.removeItem('hmas_admin_token');
                showLoginScreen();
            };

            // --- 4. نظام التنقل بين الصفحات ---
            const navigate = () => {
                const hash = window.location.hash || '#page-sections';
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const activePage = document.querySelector(hash);
                const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);
                if (activePage) activePage.classList.add('active');
                if (activeLink) activeLink.classList.add('active');
                loadPageData(hash);
            };

            const loadPageData = (hash) => {
                switch (hash) {
                    case '#page-sections': loadSections(); break;
                    case '#page-news': loadNews(); break;
                    case '#page-ads': loadAds(); break;
                    case '#page-users': loadUsers(); break;
                }
            };

            // --- 5. دوال تحميل البيانات وعرضها (Load & Render Functions) ---
            const loadSections = async () => {
                try {
                    const data = await fetchAPI('/sections');
                    const list = document.getElementById('sections-list');
                    list.innerHTML = '';
                    data.sections.forEach(s => {
                        const card = document.createElement('div');
                        card.className = 'list-card';
                        card.innerHTML = `
                            <div class="card-content">
                                <i class="${s.icon}"></i>
                                <div>
                                    <div class="card-title">${s.title}</div>
                                    <small>${s.description || ''}</small>
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="action-btn edit" title="تعديل القسم"><i class="fas fa-pen"></i></button>
                                <button class="action-btn delete" title="حذف القسم"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        card.querySelector('.card-content').addEventListener('click', () => showSectionDetails(s.id));
                        card.querySelector('.edit').addEventListener('click', (e) => { e.stopPropagation(); populateSectionForm(s); });
                        card.querySelector('.delete').addEventListener('click', (e) => { e.stopPropagation(); deleteSection(s.id, s.title); });
                        list.appendChild(card);
                    });
                } catch (e) { console.error('Failed to load sections', e); }
            };

            const showSectionDetails = async (id) => {
                App.currentSectionId = id;
                try {
                    const data = await fetchAPI(`/sections/${id}`);
                    document.getElementById('details-section-title').textContent = data.section.title;
                    const filesList = document.getElementById('files-list');
                    filesList.innerHTML = '';
                    data.files.forEach(f => {
                        const fileCard = document.createElement('div');
                        fileCard.className = 'file-card';
                        fileCard.innerHTML = `
                            <div class="file-info">
                                <i class="fas fa-file-alt"></i>
                                <span>${f.is_new ? '<span class="new-badge">جديد</span>' : ''}${f.display_name}</span>
                            </div>
                            <div class="card-actions">
                                <a href="${App.apiBaseUrl.replace('/api', '')}/${f.file_path}" target="_blank" class="action-btn" title="تحميل الملف"><i class="fas fa-download"></i></a>
                                <button class="action-btn delete" data-id="${f.id}" title="حذف الملف"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        fileCard.querySelector('.delete').addEventListener('click', () => deleteFile(f.id));
                        filesList.appendChild(fileCard);
                    });
                    document.getElementById('page-sections').classList.remove('active');
                    document.getElementById('page-section-details').classList.add('active');
                } catch (e) { console.error('Failed to load section details', e); }
            };

            const loadNews = async () => {
                try {
                    const data = await fetchAPI('/news');
                    document.getElementById('news-content').value = data.news.content;
                } catch(e) { console.error('Failed to load news', e); }
            };

            const loadAds = async () => {
                try {
                    const data = await fetchAPI('/ads');
                    document.getElementById('ad-code').value = data.ads.ad_code;
                } catch(e) { console.error('Failed to load ads', e); }
            };

            const loadUsers = async () => {
                try {
                    const data = await fetchAPI('/users');
                    const tbody = document.getElementById('users-table-body');
                    tbody.innerHTML = '';
                    data.users.forEach(u => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${u.name}</td>
                            <td>${u.student_id}</td>
                            <td>${u.password.substring(0, 15)}...</td>
                            <td class="card-actions">
                                <button class="action-btn edit" data-id="${u.id}"><i class="fas fa-pen"></i></button>
                                <button class="action-btn delete" data-id="${u.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                        row.querySelector('.edit').addEventListener('click', () => openEditUserModal(u));
                        row.querySelector('.delete').addEventListener('click', () => deleteUser(u.id, u.name));
                        tbody.appendChild(row);
                    });
                } catch (e) { console.error('Failed to load users', e); }
            };

            // --- 6. دوال الحذف والإضافة والتعديل (CRUD Functions) ---
            const populateSectionForm = (section) => { /* ... (نفس الكود من قبل) ... */ };
            const resetSectionForm = () => { /* ... (نفس الكود من قبل) ... */ };
            const deleteSection = async (id, title) => { /* ... (نفس الكود من قبل) ... */ };
            const deleteFile = async (id) => { /* ... (نفس الكود من قبل) ... */ };

            const openEditUserModal = (user) => {
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-user-name').value = user.name;
                document.getElementById('edit-user-student-id').value = user.student_id;
                document.getElementById('edit-user-password').value = '';
                document.getElementById('edit-user-modal').style.display = 'flex';
            };

            const closeEditUserModal = () => {
                document.getElementById('edit-user-modal').style.display = 'none';
            };

            const deleteUser = async (id, name) => {
                if (!confirm(`هل أنت متأكد من حذف الطالب "${name}"؟`)) return;
                try {
                    await fetchAPI(`/users/${id}`, 'DELETE');
                    loadUsers();
                } catch (e) { console.error('Failed to delete user', e); }
            };

            // --- 7. ربط الأحداث (Event Listeners) ---
            document.getElementById('admin-login-form').addEventListener('submit', handleLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', handleLogout);
            window.addEventListener('hashchange', navigate);
            
            document.getElementById('section-form').addEventListener('submit', async (e) => { /* ... (نفس الكود من قبل) ... */ });
            document.getElementById('cancel-edit-section-btn').addEventListener('click', resetSectionForm);
            document.getElementById('back-to-sections-btn').addEventListener('click', () => { /* ... (نفس الكود من قبل) ... */ });
            document.getElementById('file-form').addEventListener('submit', async (e) => { /* ... (نفس الكود من قبل) ... */ });

            document.getElementById('news-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await fetchAPI('/news', 'POST', { content: document.getElementById('news-content').value });
                    alert('تم تحديث الأخبار بنجاح!');
                } catch(e) { console.error('Failed to save news', e); }
            });

            document.getElementById('ads-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await fetchAPI('/ads', 'POST', { ad_code: document.getElementById('ad-code').value });
                    alert('تم تحديث الإعلانات بنجاح!');
                } catch(e) { console.error('Failed to save ads', e); }
            });

            document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-user-id').value;
                const body = {
                    name: document.getElementById('edit-user-name').value,
                    student_id: document.getElementById('edit-user-student-id').value,
                    password: document.getElementById('edit-user-password').value
                };
                try {
                    await fetchAPI(`/users/${id}`, 'PUT', body);
                    closeEditUserModal();
                    loadUsers();
                } catch (e) { console.error('Failed to update user', e); }
            });
            document.getElementById('cancel-edit-user-btn').addEventListener('click', closeEditUserModal);

            // --- 8. منطق نافذة اختيار الأيقونات (Icon Selector Logic) ---
            const iconGrid = document.getElementById('icon-grid');
            App.icons.forEach(icon => { /* ... (نفس الكود من قبل) ... */ });
            document.getElementById('open-icon-selector').addEventListener('click', () => { /* ... (نفس الكود من قبل) ... */ });
            document.getElementById('icon-selector-modal').addEventListener('click', (e) => { /* ... (نفس الكود من قبل) ... */ });

            // --- 9. التشغيل الأولي (Initialization) ---
            const initialToken = localStorage.getItem('hmas_admin_token');
            if (initialToken) {
                App.token = initialToken;
                showDashboard();
            } else {
                showLoginScreen();
            }
        });
    </script>
</body>
</html>
